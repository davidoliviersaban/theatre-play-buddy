# Implementation Plan: LLM-Powered Play Parser

**Branch**: `002-llm-play-parser` | **Date**: December 1, 2024 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-llm-play-parser/spec.md`

**Current Phase**: Phase 8 - Job Architecture Redesign (Planning)

## Summary

LLM-powered parsing system that accepts play scripts (PDF/DOCX/TXT), extracts structured data (characters, acts, scenes, dialogue), and streams progress to users. Uses Vercel AI SDK with Anthropic Claude for structured object generation, Zod for validation, and incremental chunking for large files.

## Implementation Status

### âœ… Completed (December 1, 2024)

**ID Generation Refactoring**: Resolved duplicate key errors by implementing database-authority pattern:

- All primary keys (`id`) generated by Prisma using `@default(uuid())`
- LLM-generated IDs stored as `llmSourceId` for debugging only
- Character mapping table translates LLM IDs to database IDs during persistence
- Sequential entity creation (playbookâ†’actsâ†’scenesâ†’lines) ensures proper FK relationships
- Files modified:
  - `src/lib/db/plays-db-prisma.ts`: `savePlay()` omits manual IDs
  - `src/lib/parse/schemas.ts`: All IDs marked optional
  - `src/lib/parse/incremental-parser.ts`: `contextToPlaybook()` no longer generates IDs
  - `scripts/seed.ts`: Updated to use `savePlay()`
  - `src/lib/db/init-db.ts`: Updated to use `savePlay()`

### ï¿½ Planned - Not Started

**Job Architecture Redesign**: Architecture analysis and design completed. Implementation ready to begin. See [PARSING_JOB_ARCHITECTURE.md](../../PARSING_JOB_ARCHITECTURE.md) for:

- Current architecture analysis (dual-path execution model)
- Identified problems (no job queue, weak concurrency control, limited observability)
- Proposed solution (unified queue, state machine, worker pool)
- 6-phase implementation plan with rollout strategy

## Technical Context

**Language/Version**: TypeScript 5.x with Next.js 14 (App Router)  
**Primary Dependencies**:

- Next.js 14 (App Router, API Routes, SSE streaming)
- Prisma 7.0.1 with @prisma/adapter-pg (PostgreSQL ORM)
- Vercel AI SDK (LLM integration with streaming)
- Anthropic Claude 3.5 Sonnet (primary LLM)
- OpenAI GPT-4 (fallback LLM)
- Zod (schema validation)
- pdf-parse, mammoth (document extraction)

**Storage**: PostgreSQL 17 (Docker container) with Prisma ORM  
**Testing**: Jest (unit tests), manual integration testing  
**Target Platform**: Web (local Docker deployment)  
**Project Type**: Next.js full-stack (single app with client + server)  
**Performance Goals**:

- Parsing completion < 3 minutes for standard plays
- SSE progress updates every 5 seconds
- Real-time character detection streaming
  **Constraints**: Docker-based deployment, LLM API dependency (external)  
  **Scale/Scope**: Single-user local deployment; concurrent parsing sessions supported via job queue

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

Verify compliance with Theatre Play Buddy Constitution principles:

- [x] **Principle I (Actor-Centered Practice)**: âœ… Enables actors to import any play for practice
- [x] **Principle II (Multi-Format Ingestion)**: âœ… Supports PDF/TXT/DOCX upload and extraction
- [x] **Principle III (Structured Play Model)**: âœ… Outputs conform to Playbook/Act/Scene/Line schema
- [N/A] **Principle IV (Search & Discovery)**: N/A - Import feature, not search
- [N/A] **Principle V (Real-Time Audio)**: N/A - Text parsing only, no audio processing
- [N/A] **Principle VI (Error Assistance)**: N/A - No practice flow in this feature
- [N/A] **Principle VII (Progress Tracking)**: N/A - No practice tracking in this feature
- [âš ï¸] **Principle VIII (Privacy-First)**: âš ï¸ **VIOLATION** - Uploaded plays sent to external LLM API
- [N/A] **Performance Target**: N/A - Audio latency not applicable to parsing
- [x] **Data Model Conformance**: âœ… All play data uses Playbook schema with Prisma models

### Privacy Exception Justification

**Violation**: Uploaded play text is transmitted to external LLM APIs (Anthropic/OpenAI) for parsing.

**Why Needed**: Local LLM alternatives (Llama, Mistral) lack:

1. Context window size for full-length plays (requires 100K+ tokens)
2. Structured output reliability (critical for schema conformance)
3. Performance parity (local inference too slow for 3-minute target)

**Simpler Alternative Rejected**:

- Regex/rule-based parsing: Fails on non-standard formatting (tested, <60% accuracy)
- Local LLM: Cannot fit full-length plays in context, unreliable structured output
- Manual entry: Defeats purpose of import feature (user wants automation)

**Mitigation**: Users must consciously upload files; no automatic transmission of existing data.

_Re-evaluated: December 1, 2024 - Status: Approved with documented exception_

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

**Structure Decision**: Single Next.js project with App Router (standard Theatre Play Buddy architecture)

```text
src/app/
â”œâ”€â”€ import/
â”‚   â”œâ”€â”€ page.tsx                           # Import UI page
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ parse/route.ts                 # SSE parsing endpoint (current: dual-path)
â”‚       â””â”€â”€ sessions/[id]/
â”‚           â”œâ”€â”€ continue/route.ts          # Resume incremental parse
â”‚           â””â”€â”€ restart/route.ts           # Restart failed parse
â”œâ”€â”€ api/
â”‚   â””â”€â”€ jobs/                              # (PLANNED) New job control APIs
â”‚       â”œâ”€â”€ route.ts                       # POST create, GET list
â”‚       â””â”€â”€ [id]/
â”‚           â”œâ”€â”€ route.ts                   # GET status
â”‚           â”œâ”€â”€ pause/route.ts             # POST pause
â”‚           â”œâ”€â”€ resume/route.ts            # POST resume
â”‚           â””â”€â”€ cancel/route.ts            # POST cancel

src/lib/
â”œâ”€â”€ parse/
â”‚   â”œâ”€â”€ schemas.ts                         # Zod schemas (Playbook, Character, Act, Scene, Line)
â”‚   â”œâ”€â”€ validation.ts                      # Schema guards and refinements
â”‚   â”œâ”€â”€ extractors.ts                      # PDF/DOCX/TXT text extraction
â”‚   â”œâ”€â”€ llm-parser.ts                      # LLM provider factory and parsing logic
â”‚   â”œâ”€â”€ incremental-parser.ts              # Chunked parsing with context accumulation
â”‚   â”œâ”€â”€ session-runner.ts                  # Background job executor (current)
â”‚   â””â”€â”€ multi-character.ts                 # Multi-speaker line helpers
â”œâ”€â”€ jobs/                                  # (PLANNED) New job infrastructure
â”‚   â”œâ”€â”€ queue.ts                           # JobQueue service (enqueue, claim, complete)
â”‚   â”œâ”€â”€ worker.ts                          # JobWorker class with heartbeat
â”‚   â”œâ”€â”€ state-machine.ts                   # State transition validator
â”‚   â”œâ”€â”€ parse-pipeline.ts                  # Unified parse execution pipeline
â”‚   â””â”€â”€ bootstrap.ts                       # Worker pool initialization
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ prisma.ts                          # PrismaClient singleton
â”‚   â”œâ”€â”€ plays-db-prisma.ts                 # savePlay(), getPlay() persistence
â”‚   â”œâ”€â”€ parsing-session-db.ts              # (CURRENT) ParsingSession CRUD
â”‚   â””â”€â”€ parse-job-db.ts                    # (PLANNED) ParseJob CRUD

src/components/import/
â”œâ”€â”€ file-upload.tsx                        # Drag-drop upload UI
â”œâ”€â”€ parse-progress.tsx                     # SSE progress display
â”œâ”€â”€ parse-error-display.tsx                # Error messages and recovery hints
â””â”€â”€ failed-imports-list.tsx                # Failed session list

prisma/
â”œâ”€â”€ schema.prisma                          # Current: ParsingSession model
â”‚                                          # Planned: ParseJob model (replaces ParsingSession)
â””â”€â”€ migrations/

tests/parse/
â”œâ”€â”€ extractors.test.ts                     # Text extraction unit tests
â”œâ”€â”€ schemas.test.ts                        # Zod schema validation tests
â”œâ”€â”€ multi-character.test.ts                # Multi-speaker helpers tests
â””â”€â”€ llm-parser.test.ts                     # Integration test (uploadâ†’parseâ†’persist)

scripts/
â””â”€â”€ seed.ts                                # Database seeding (uses savePlay())
```

## Complexity Tracking

| Violation                  | Why Needed                                                                                  | Simpler Alternative Rejected Because                                                                  |
| -------------------------- | ------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| External LLM API (Privacy) | Parse unstructured play text into schema-conformant data                                    | Local LLMs lack 100K+ context window, structured output reliability, and performance for 3-min target |
| Job Queue Architecture     | Handle long-running parses (5+ min), enable pause/resume, prevent concurrent duplicate jobs | Fire-and-forget async lacks observability, cancellation, crash recovery, and distributed-safe locking |

## Phase 0: Research & Decision Log

### Research Completed (November 30, 2024)

See [research.md](./research.md) for full details. Key decisions:

**LLM Provider**: Anthropic Claude 3.5 Sonnet (primary), OpenAI GPT-4 (fallback)

- **Rationale**: 200K token context window, excellent structured output, streaming support
- **Alternatives**: Llama 3.1 (rejected: local deployment complexity, unreliable structured output)

**Parsing Strategy**: Incremental chunking with context accumulation

- **Rationale**: Handles plays > 200K tokens, provides progress updates, resumable on failure
- **Alternatives**: Single-shot parsing (rejected: context window limits), streaming without chunks (rejected: no checkpoint/resume)

**Validation**: Zod schemas with runtime validation + LLM structured output

- **Rationale**: Type-safe, auto-validated, catches schema violations before persistence
- **Alternatives**: Manual parsing (rejected: error-prone), TypeScript types only (rejected: no runtime checks)

## Phase 1: Design & Contracts

### Data Model

See [data-model.md](./data-model.md) for complete Prisma schema. Key entities:

**Core Entities** (already implemented):

- `Playbook`: Title, author, year, genre, description
- `Character`: Name, description, llmSourceId (for LLM ID mapping)
- `Act`: Title, act number, llmSourceId
- `Scene`: Title, scene number, llmSourceId
- `Line`: Text, type (dialogue/stage_direction), llmSourceId
- `LineCharacter`: Many-to-many join (supports multi-speaker lines)

**Job Management** (current):

- `ParsingSession`: Status (pending/warming/parsing/completed/failed/aborted), currentChunk, totalChunks, currentState (JSON), timestamps

**Job Management** (planned Phase 8):

- `ParseJob`: Replaces ParsingSession with robust status enum (queued/running/paused/retrying/completed/failed/cancelled), priority, retryCount, distributed lock fields (workerId, lockedAt, lockExpiry), checkpoints array

### API Contracts

See [contracts/](./contracts/) for OpenAPI specs:

**Current Endpoints**:

- `POST /api/import/api/parse` - Start new parse (returns SSE stream)
- `POST /api/import/sessions/{id}/continue` - Resume from last chunk
- `POST /api/import/sessions/{id}/restart` - Restart from beginning

**Planned Endpoints** (Phase 8):

- `POST /api/jobs/parse` - Submit new job (returns jobId)
- `GET /api/jobs/{id}` - Get job status + progress
- `POST /api/jobs/{id}/pause` - Pause running job
- `POST /api/jobs/{id}/resume` - Resume paused job
- `POST /api/jobs/{id}/cancel` - Cancel job
- `GET /api/jobs` - List jobs (filterable by status)
- `GET /api/metrics` - Job queue metrics
- `GET /api/health` - Worker health check

### Quickstart

See [quickstart.md](./quickstart.md) for development setup and usage examples.

## Phase 2: Implementation Tasks

See [tasks.md](./tasks.md) for detailed task breakdown. Summary:

**Phases 1-6**: âœ… Completed (core parsing functionality)
**Phase 7**: âœ… Completed (ID generation refactoring)
**Phase 8**: ðŸ”„ In Progress (job architecture redesign)

Current task: Planning Phase 8 implementation (6-week rollout plan documented in [PARSING_JOB_ARCHITECTURE.md](../../PARSING_JOB_ARCHITECTURE.md))

## Next Steps

1. **Review Architecture Document**: [PARSING_JOB_ARCHITECTURE.md](../../PARSING_JOB_ARCHITECTURE.md)
2. **Approve Design**: Confirm state machine, job queue, and worker pool approach
3. **Begin Week 1**: Database migration (ParsingSession â†’ ParseJob)
4. **Parallel Run**: Shadow mode deployment for validation before cutover
