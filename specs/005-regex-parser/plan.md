# Implementation Plan: Regex-Based Play File Parsing

**Branch**: `005-regex-parser` | **Date**: 2025-12-03 | **Spec**: `/specs/005-regex-parser/spec.md`
**Input**: Feature specification from `/specs/005-regex-parser/spec.md`

**Note**: Generated by speckit.plan workflow.

## Summary

Provide a deterministic, regex-driven parsing pipeline as an alternative to the LLM parser to significantly reduce parsing time (target: <30s for ~100 pages) while maintaining conformance to the StructuredPlay data model. The pipeline runs in three phases: (1) extract hints (acts, scenes, candidate characters, stage direction markers), (2) assemble configurable PatternPreset regexes from hints and normalization rules, and (3) parse the entire file into StructuredPlay with metrics and fallbacks.

## Technical Context

<!--
  ACTION REQUIRED: Replace the content in this section with the technical details
  for the project. The structure here is presented in advisory capacity to guide
  the iteration process. For Theatre Play Buddy, many of these are defined in the
  constitution.
-->

**Language/Version**: TypeScript/JavaScript with Next.js (latest stable)  
**Primary Dependencies**: Next.js, Prisma (ORM), Whisper (STT), Local TTS, Tailwind CSS  
**Storage**: PostgreSQL with pgvector extension  
**Testing**: Jest (unit + integration), optional Playwright for admin UI presets  
**Target Platform**: Web (local Docker deployment)  
**Project Type**: Next.js full-stack (single app with client + server)  
**Performance Goals**: <200ms end-of-sentence detection latency (CONSTITUTIONAL REQUIREMENT)  
**Constraints**: Local-first (no external data transmission), Docker-based deployment  
**Scale/Scope**: Single-user local deployment initially; multi-user support TBD

Additional context for this feature:

- Parser should process plain text extracted from PDF/DOC/DOCX before regex phase (existing ingestion path).
- PatternPreset supports multiple conventions (e.g., Shakespeare, modern scripts); defaults auto-selected via hints with admin override.
- Metrics: duration, total lines, dialogue hit rate, stage-direction hit rate, unmatched percentage; logged to app logs and stored per file.

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

Verify compliance with Theatre Play Buddy Constitution principles:

- [x] **Principle I (Actor-Centered Practice)**: Enables faster ingestion to unlock practice sooner.
- [x] **Principle II (Multi-Format Ingestion)**: Works on text extracted from PDF/TXT/DOC/DOCX. Natively targets TXT.
- [x] **Principle III (Structured Play Model)**: Output strictly conforms to StructuredPlay (Acts → Scenes → Lines; dialogue vs stage_direction).
- [x] **Principle IV (Search & Discovery)**: Parsed structure supports search facets; no changes required.
- [n/a] **Principle V (Real-Time Audio)**: Not audio-related; unaffected.
- [n/a] **Principle VI (Error Assistance)**: Not practice mode; unaffected.
- [x] **Principle VII (Progress Tracking)**: Indirectly supported via consistent parsing; no schema change.
- [x] **Principle VIII (Privacy-First)**: Fully local; no external services.
- [x] **Performance Target**: End-of-sentence detection unaffected; ingestion performance improved (<30s parse target).
- [x] **Data Model Conformance**: Uses StructuredPlay schema.

_Mark N/A if principle not applicable to this feature_

## Project Structure

### Documentation (this feature)

```text
specs/005-regex-parser/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

<!--
  ACTION REQUIRED: Replace the placeholder tree below with the concrete layout
  for this feature. Delete unused options and expand the chosen structure with
  real paths (e.g., apps/admin, packages/something). The delivered plan must
  not include Option labels.
-->

```text
# Single Next.js project (DEFAULT for Theatre Play Buddy)
# Next.js full-stack architecture (client + server in one project)
app/                     # Next.js 13+ App Router
├── (auth)/             # Route groups for authenticated pages
├── api/                # API routes
└── components/         # React components

src/
├── lib/                # Shared utilities
├── models/             # Prisma models & StructuredPlay schema
├── services/           # Business logic (audio, RAG, play processing)
└── audio/              # Whisper + TTS integration

prisma/
├── schema.prisma       # Database schema (PostgreSQL + pgvector)
└── migrations/

tests/
├── contract/           # StructuredPlay model conformance tests
├── integration/        # Audio pipeline, practice flow tests
└── unit/

# [REMOVE IF UNUSED] Option 2: Monorepo with separate Next.js app + packages
apps/
└── web/                # Next.js application
    ├── app/
    ├── src/
    └── tests/

packages/
├── audio/              # Whisper + TTS package
├── models/             # StructuredPlay schema
└── rag/                # RAG knowledge base

# [REMOVE IF UNUSED] Option 3: Separate frontend/backend (NOT RECOMMENDED for this project)
# Theatre Play Buddy uses Next.js full-stack, so frontend/backend split not needed
backend/
├── src/
│   ├── models/
│   ├── services/
│   └── api/
└── tests/

frontend/
├── src/
│   ├── components/
│   ├── pages/
│   └── services/
└── tests/

# [REMOVE IF UNUSED] Option 4: Mobile + API (future consideration for Theatre Play Buddy)
api/
└── [same as backend above]

ios/ or android/
└── [platform-specific structure: feature modules, UI flows, platform tests]
```

**Structure Decision**: Use existing single Next.js project structure. Regex parser will live in `src/lib/parse/regex/` with presets in `src/lib/parse/presets/`. API route for invoking parser at `app/api/parse/regex/route.ts`. Tests under `tests/parse/regex/`.

## Gates & Risks

- Gate: Maintain ≥95% accuracy for conventional formats; if <95%, require fallback heuristics flag and log.
- Risk: Non-standard layout brittleness → Mitigation via alias table, normalization, and low-confidence markers.

## Phase 0 → Phase 1 linkage

- Phase 0 resolves PatternPreset scope and normalization rules; defines metrics targets.
- Phase 1 designs data contracts and storage of parse metrics.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation                  | Why Needed         | Simpler Alternative Rejected Because |
| -------------------------- | ------------------ | ------------------------------------ |
| [e.g., 4th project]        | [current need]     | [why 3 projects insufficient]        |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient]  |
